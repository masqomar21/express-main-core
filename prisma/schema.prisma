generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Loger {
  id        Int      @id @default(autoincrement())
  userId    Int
  process   Process
  detail    String
  createdAt DateTime @default(now())
  User      User     @relation(fields: [userId], references: [id])
}

model Notification {
  id               Int                @id @default(autoincrement())
  type             String
  refId            String?
  message          String
  createdAt        DateTime           @default(now())
  NotificationUser NotificationUser[]
}

model NotificationUser {
  id             Int          @id @default(autoincrement())
  userId         Int
  notificationId Int
  readStatus     Boolean      @default(false)
  readAt         DateTime?
  deliveredAt    DateTime?
  Notification   Notification @relation(fields: [notificationId], references: [id], onDelete: Cascade)
  User           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, notificationId])
  @@index([notificationId])
  @@index([userId, readStatus])
}

model Otp {
  id        Int        @id @default(autoincrement())
  userId    Int        @unique
  code      String     @unique
  createdAt DateTime   @default(now())
  expiresAt DateTime
  purpose   OtpPurpose
  User      User       @relation(fields: [userId], references: [id])
}

model Permissions {
  id             Int              @id @default(autoincrement())
  name           String
  label          String
  RolePermission RolePermission[]
}

model Role {
  id             Int              @id @default(autoincrement())
  name           String
  roleType       RoleType         @default(OTHER)
  RolePermission RolePermission[]
  User           User[]
}

model RolePermission {
  id           Int         @id @default(autoincrement())
  roleId       Int
  permissionId Int
  canRead      Boolean     @default(false)
  canWrite     Boolean     @default(false)
  canUpdate    Boolean     @default(false)
  canDelete    Boolean     @default(false)
  canRestore   Boolean     @default(false)
  Permissions  Permissions @relation(fields: [permissionId], references: [id])
  Role         Role        @relation(fields: [roleId], references: [id])
}

model Session {
  id        Int       @id @default(autoincrement())
  token     String    @unique
  userId    Int
  createdAt DateTime  @default(now())
  updatedAt DateTime
  deletedAt DateTime?
  User      User      @relation(fields: [userId], references: [id])
}

model User {
  id                  Int                   @id @default(autoincrement())
  email               String                @unique
  name                String?
  password            String?
  roleId              Int
  createdAt           DateTime              @default(now())
  updatedAt           DateTime
  deletedAt           DateTime?
  registeredViaGoogle Boolean               @default(false)
  Loger               Loger[]
  NotificationUser    NotificationUser[]
  Otp                 Otp?
  Session             Session[]
  Role                Role                  @relation(fields: [roleId], references: [id])
  WebPushSubscription WebPushSubscription[]
}

model WebPushSubscription {
  id             Int       @id @default(autoincrement())
  userId         Int
  endpoint       String    @unique
  p256dh         String
  auth           String
  expirationTime DateTime?
  userAgent      String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime
  User           User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

enum OtpPurpose {
  LOGIN
  RESET_PASSWORD
  VERIFY_EMAIL
}

enum Process {
  CREATE
  UPDATE
  DELETE
  RESTORE
  LOGIN
  LOGOUT
}

enum RoleType {
  OTHER
  SUPER_ADMIN
}
